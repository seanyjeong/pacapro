# 시즌 전환 로직 상세 분석 및 테스트 케이스

## 1. 시즌 전환 로직 개요

시즌 전환은 P-ACA 시스템에서 가장 복잡한 비즈니스 로직입니다. 학생이 **월회비 시스템**에서 **시즌비 시스템**으로 전환할 때 발생하는 복잡한 일할 계산을 처리합니다.

---

## 2. 핵심 개념 정의

### 2.1 용어 정의
- **월회비 (Monthly Fee)**: 매월 정해진 날짜에 납부하는 수강료 (예: 매월 40만원)
- **시즌비 (Season Fee)**: 특정 기간(시즌) 동안 한꺼번에 납부하는 통합 수강료
- **비시즌 종강일**: 월회비 시스템의 마지막 수업 날짜
- **공백기**: 비시즌 종강일 다음날부터 시즌 시작일 전날까지의 수업 없는 기간
- **시즌 시작일**: 시즌비로 전환된 후 수업이 시작되는 날짜

### 2.2 시즌 전환 시나리오
```
타임라인:
|------ 월회비 기간 ------|--- 공백기 ---|--------- 시즌비 기간 ---------|
                     비시즌종강일    시즌시작일

예시:
|---- 11/1 ~ 11/5 -----|--11/6~11/15--|---- 11/16 ~ 시즌종료일 ----|
     (월회비 일할)        (수업없음)          (시즌비 적용)
```

---

## 3. 계산 로직 상세

### 3.1 기본 시나리오 (기획서 예시)

**조건:**
- 학생: 주 3회 수업
- 기존 월회비: 40만원
- 비시즌 종강일: 11월 5일
- 공백기: 11월 6일 ~ 11월 15일
- 시즌 시작일: 11월 16일

**계산 프로세스:**

#### Step 1: 11월 수강료 일할 계산
```
목표: 11월 1일 ~ 11월 5일까지의 수강료만 계산

방법 A - 수업 횟수 기반:
1. 11월 1일 ~ 11월 5일 사이 학생의 등록 요일 카운트
   예) 학생이 월/수/금 수업 등록 → 11/1(금), 11/3(월), 11/5(수) = 3회
2. 회당 단가 = 월회비 ÷ 한 달 예상 수업 횟수
   예) 40만원 ÷ 12회 (주3회 × 4주) = 33,333원/회
3. 일할 계산 = 회당 단가 × 실제 수업 횟수
   예) 33,333원 × 3회 = 99,999원

방법 B - 일할 계산:
1. 한 달 총 수업일 = 11월 중 학생 등록 요일 카운트
   예) 11월 월/수/금: 총 13일
2. 일당 수강료 = 월회비 ÷ 총 수업일
   예) 40만원 ÷ 13일 = 30,769원/일
3. 일할 계산 = 일당 수강료 × 비시즌종강일까지 수업일
   예) 30,769원 × 3일 = 92,307원

📌 **권장 방법**: 방법 A (수업 횟수 기반)
   - 더 직관적이고 이해하기 쉬움
   - 학생/학부모가 납득하기 쉬운 계산 방식
```

#### Step 2: 공백기 처리
```
11월 6일 ~ 11월 15일: 청구 금액 0원
- 이 기간은 수업이 없으므로 별도 계산 불필요
- 시스템에서 자동으로 제외
```

#### Step 3: 시즌비 처리
```
11월 16일부터: 시즌비로 전환
- 시즌비는 시즌 등록 시 한꺼번에 받음
- 월별 수강료 청구 중단
- 시즌 종료일까지 추가 월회비 없음
```

### 3.2 시즌비 청구 시점

**중요한 규칙:**
```
시즌비는 시즌 시작 전달에 별도로 청구하지 않음
시즌 등록 시점에 이미 한꺼번에 납부받았기 때문

예시:
- 시즌 등록일: 10월 25일
- 시즌비: 200만원 (10/25에 납부 완료)
- 11월 청구: 비시즌종강일까지의 일할 금액만 (99,999원)
- 12월 ~ 시즌 종료일: 청구 없음
```

---

## 4. 복잡한 케이스 시나리오

### Case 1: 월 중간에 시즌 시작
```
조건:
- 월회비: 50만원 (주 5회)
- 비시즌 종강일: 3월 17일 (금)
- 공백기: 3월 18일 ~ 3월 20일
- 시즌 시작일: 3월 21일 (월)

계산:
1. 3월 1일 ~ 3월 17일 수업 횟수 계산
   - 월~금 수업: 3/1~3/17 사이 평일 = 13일
   - 회당 단가: 50만원 ÷ 22일 (3월 평일) = 22,727원
   - 일할 금액: 22,727원 × 13일 = 295,451원

2. 3월 청구 금액: 295,451원 (시즌비 제외)
3. 3월 21일부터: 시즌비 적용 (월회비 청구 중단)
```

### Case 2: 시즌 중도 해지 (환불 계산)
```
조건:
- 시즌비: 300만원
- 시즌 기간: 11/16 ~ 2/28 (105일, 주5회 가정 = 75일 수업일)
- 중도 해지일: 1/15 (시작 60일 경과, 수업일 42일)

학원법 기준 환불 규정:
1. 1/3 경과 전: 2/3 환불
2. 1/2 경과 전: 1/2 환불
3. 1/2 경과 후: 환불 없음

계산:
- 경과율: 42일 ÷ 75일 = 56% (1/2 경과 후)
- 환불액: 0원 (또는 학원 정책에 따라 일할 계산)

일할 환불 계산 (학원 정책):
- 일당 단가: 300만원 ÷ 75일 = 40,000원
- 사용 금액: 40,000원 × 42일 = 1,680,000원
- 환불액: 300만원 - 1,680,000원 = 1,320,000원
```

### Case 3: 비시즌 종강일이 월말인 경우
```
조건:
- 월회비: 45만원 (주 4회)
- 비시즌 종강일: 4월 30일
- 공백기: 없음 (5/1부터 바로 시즌 시작)
- 시즌 시작일: 5월 1일

계산:
1. 4월 전체 월회비: 45만원 (정상 청구)
2. 5월부터: 시즌비 적용
```

### Case 4: 주 횟수가 다른 학생들
```
조건 A: 주 1회 학생
- 월회비: 15만원
- 비시즌 종강일: 11/5
- 11월 1~5일 사이 해당 요일: 1회
- 일할 금액: 15만원 ÷ 4회 × 1회 = 37,500원

조건 B: 주 7회 학생
- 월회비: 60만원
- 비시즌 종강일: 11/5
- 11월 1~5일: 5일
- 일할 금액: 60만원 ÷ 30일 × 5일 = 100,000원
```

---

## 5. 데이터베이스 설계

### 5.1 시즌 설정 테이블
```sql
CREATE TABLE season_settings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    season_name VARCHAR(100) NOT NULL COMMENT '시즌명 (예: 2025 수시, 2025 정시)',
    season_start_date DATE NOT NULL COMMENT '시즌 시작일',
    season_end_date DATE NOT NULL COMMENT '시즌 종료일',
    non_season_end_date DATE NOT NULL COMMENT '비시즌 종강일',
    default_season_fee DECIMAL(10,2) COMMENT '기본 시즌비 (참고용)',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 5.2 학생-시즌 등록 테이블
```sql
CREATE TABLE student_seasons (
    id INT PRIMARY KEY AUTO_INCREMENT,
    student_id INT NOT NULL,
    season_id INT NOT NULL,
    season_fee DECIMAL(10,2) NOT NULL COMMENT '해당 학생의 시즌비',
    registration_date DATE NOT NULL COMMENT '시즌 등록일',
    paid_date DATE COMMENT '시즌비 납부일',
    payment_status ENUM('pending', 'paid', 'cancelled') DEFAULT 'pending',
    after_season_action ENUM('regular', 'reregister', 'terminate') COMMENT '시즌 종료 후 거취',
    cancellation_date DATE COMMENT '중도 해지일',
    refund_amount DECIMAL(10,2) COMMENT '환불액',
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (season_id) REFERENCES season_settings(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 5.3 학생 수강료 테이블 (월별)
```sql
CREATE TABLE student_payments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    student_id INT NOT NULL,
    year_month VARCHAR(7) NOT NULL COMMENT 'YYYY-MM',
    payment_type ENUM('monthly', 'season', 'product') NOT NULL,
    base_amount DECIMAL(10,2) NOT NULL COMMENT '기본 수강료',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT '할인액',
    actual_amount DECIMAL(10,2) NOT NULL COMMENT '실제 청구액',
    is_prorated BOOLEAN DEFAULT FALSE COMMENT '일할 계산 여부',
    proration_details TEXT COMMENT '일할 계산 상세 (JSON)',
    payment_date DATE COMMENT '납부일',
    payment_status ENUM('pending', 'paid', 'overdue') DEFAULT 'pending',
    due_date DATE NOT NULL COMMENT '납부 예정일',
    season_id INT COMMENT '시즌 전환 시 시즌 ID',
    notes TEXT,
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (season_id) REFERENCES season_settings(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_year_month (year_month),
    INDEX idx_payment_status (payment_status)
);
```

---

## 6. 알고리즘 구현 (의사코드)

### 6.1 시즌 전환 시 일할 계산
```javascript
function calculateProRatedFee(student, seasonSettings) {
    const {
        monthlyFee,           // 월회비
        weeklyDays,           // 학생 등록 요일 배열 [1,3,5] = 월,수,금
        nonSeasonEndDate,     // 비시즌 종강일
        seasonStartDate       // 시즌 시작일
    } = student;

    // Step 1: 비시즌 종강일이 속한 달의 1일부터 종강일까지 수업 횟수 계산
    const month = nonSeasonEndDate.getMonth();
    const year = nonSeasonEndDate.getFullYear();
    const startDate = new Date(year, month, 1);

    let classCount = 0;
    for (let date = new Date(startDate); date <= nonSeasonEndDate; date.setDate(date.getDate() + 1)) {
        const dayOfWeek = date.getDay(); // 0=일요일, 1=월요일, ..., 6=토요일
        if (weeklyDays.includes(dayOfWeek)) {
            classCount++;
        }
    }

    // Step 2: 해당 월의 총 수업 횟수 계산
    const lastDayOfMonth = new Date(year, month + 1, 0);
    let totalMonthlyClasses = 0;
    for (let date = new Date(startDate); date <= lastDayOfMonth; date.setDate(date.getDate() + 1)) {
        const dayOfWeek = date.getDay();
        if (weeklyDays.includes(dayOfWeek)) {
            totalMonthlyClasses++;
        }
    }

    // Step 3: 일할 계산
    const perClassFee = monthlyFee / totalMonthlyClasses;
    const proRatedFee = Math.floor(perClassFee * classCount); // 원단위 절사

    return {
        proRatedFee,
        classCount,
        totalMonthlyClasses,
        perClassFee,
        calculationDetails: {
            period: `${startDate.toISOString().split('T')[0]} ~ ${nonSeasonEndDate.toISOString().split('T')[0]}`,
            formula: `${monthlyFee}원 ÷ ${totalMonthlyClasses}회 × ${classCount}회 = ${proRatedFee}원`
        }
    };
}
```

### 6.2 시즌 중도 해지 환불 계산
```javascript
function calculateSeasonRefund(studentSeason, cancellationDate) {
    const {
        seasonFee,
        seasonStartDate,
        seasonEndDate,
        weeklyDays
    } = studentSeason;

    // Step 1: 시즌 전체 수업일 계산
    let totalClassDays = 0;
    for (let date = new Date(seasonStartDate); date <= seasonEndDate; date.setDate(date.getDate() + 1)) {
        if (weeklyDays.includes(date.getDay())) {
            totalClassDays++;
        }
    }

    // Step 2: 실제 수업 받은 일수 계산
    let attendedDays = 0;
    for (let date = new Date(seasonStartDate); date <= cancellationDate; date.setDate(date.getDate() + 1)) {
        if (weeklyDays.includes(date.getDay())) {
            attendedDays++;
        }
    }

    // Step 3: 진행률 계산
    const progressRate = attendedDays / totalClassDays;

    // Step 4: 환불 정책 적용
    let refundRate;
    if (progressRate < 1/3) {
        refundRate = 2/3;  // 2/3 환불
    } else if (progressRate < 1/2) {
        refundRate = 1/2;  // 1/2 환불
    } else {
        // 학원 정책에 따라 선택
        // Option 1: 학원법 준수 (환불 없음)
        refundRate = 0;

        // Option 2: 일할 환불
        // refundRate = (totalClassDays - attendedDays) / totalClassDays;
    }

    const refundAmount = Math.floor(seasonFee * refundRate);

    return {
        refundAmount,
        totalClassDays,
        attendedDays,
        progressRate: (progressRate * 100).toFixed(2) + '%',
        refundRate: (refundRate * 100).toFixed(2) + '%',
        usedAmount: seasonFee - refundAmount
    };
}
```

---

## 7. 테스트 케이스

### Test Case 1: 기본 시나리오
```javascript
const testCase1 = {
    student: {
        name: "김철수",
        monthlyFee: 400000,
        weeklyDays: [1, 3, 5], // 월, 수, 금
        discount: 0
    },
    season: {
        nonSeasonEndDate: new Date('2025-11-05'),
        seasonStartDate: new Date('2025-11-16'),
        seasonEndDate: new Date('2026-02-28'),
        seasonFee: 2000000
    },
    expected: {
        proRatedFee: 100000, // 대략적인 예상값
        classCountInNovember: 3 // 11/1(토-불포함), 11/3(월), 11/5(수)
    }
};
```

### Test Case 2: 주 7회 학생
```javascript
const testCase2 = {
    student: {
        name: "이영희",
        monthlyFee: 600000,
        weeklyDays: [1, 2, 3, 4, 5, 6, 0], // 매일
        discount: 0
    },
    season: {
        nonSeasonEndDate: new Date('2025-11-05'),
        seasonStartDate: new Date('2025-11-16'),
        seasonEndDate: new Date('2026-02-28'),
        seasonFee: 3000000
    },
    expected: {
        proRatedFee: 100000, // 600000 ÷ 30 × 5
        classCountInNovember: 5
    }
};
```

### Test Case 3: 중도 해지 (1/3 경과 전)
```javascript
const testCase3 = {
    studentSeason: {
        seasonFee: 3000000,
        seasonStartDate: new Date('2025-11-16'),
        seasonEndDate: new Date('2026-02-28'),
        weeklyDays: [1, 2, 3, 4, 5], // 평일만
        cancellationDate: new Date('2025-12-10') // 약 25일 경과
    },
    expected: {
        refundRate: 2/3,
        refundAmount: 2000000
    }
};
```

### Test Case 4: 비시즌 종강일이 월말
```javascript
const testCase4 = {
    student: {
        name: "박민수",
        monthlyFee: 450000,
        weeklyDays: [1, 2, 4, 5], // 월,화,목,금
        discount: 0
    },
    season: {
        nonSeasonEndDate: new Date('2025-04-30'),
        seasonStartDate: new Date('2025-05-01'),
        seasonEndDate: new Date('2025-08-31'),
        seasonFee: 1800000
    },
    expected: {
        proRatedFee: 450000, // 4월 전체
        classCountInApril: 17 // 4월 평일 수
    }
};
```

---

## 8. UI/UX 요구사항

### 8.1 시즌 등록 화면
```
화면 구성:
1. 학생 선택
2. 시즌 선택 (드롭다운)
3. 시즌비 입력
4. 시즌 종료 후 거취 선택
   - [ ] 정시 전환
   - [ ] 자동 재등록
   - [ ] 등록 종료
5. [일할 계산 미리보기] 버튼
   → 팝업: 다음 달 청구 금액 계산 결과 표시
6. [시즌 등록] 버튼
```

### 8.2 일할 계산 미리보기 팝업
```
===========================================
시즌 전환 청구 금액 계산
===========================================

학생: 김철수
기존 월회비: 400,000원 (주 3회)
비시즌 종강일: 2025년 11월 5일
시즌 시작일: 2025년 11월 16일

-------------------------------------------
[11월 청구 금액 계산]
-------------------------------------------
11월 1일 ~ 11월 5일 수업 횟수: 3회
11월 전체 예상 수업 횟수: 13회
회당 단가: 30,769원

일할 계산: 30,769원 × 3회 = 92,307원

-------------------------------------------
✓ 11월 청구 금액: 92,307원
✓ 11월 6일 ~ 11월 15일: 청구 없음 (공백기)
✓ 11월 16일부터: 시즌비 적용 (월회비 청구 중단)
-------------------------------------------

[확인] [취소]
```

---

## 9. 주의사항 및 엣지 케이스

### 9.1 공휴일 처리
```
문제: 학생 등록 요일이 공휴일과 겹치는 경우
해결: 학원 정책에 따라 선택
  Option 1: 공휴일도 수업일로 카운트 (휴무 시 보강)
  Option 2: 공휴일 제외 (별도 공휴일 테이블 관리)
```

### 9.2 월말/월초 경계
```
문제: 비시즌 종강일이 월말, 시즌 시작일이 다음달 1일
해결: 정상적으로 한 달 전체 청구
```

### 9.3 시즌비 미납 상태에서 중도 해지
```
문제: 시즌비를 아직 납부하지 않은 상태에서 해지 요청
해결:
  - 수업 받은 기간만큼 일할 계산하여 청구
  - 환불이 아닌 미납 정산
```

### 9.4 시즌 중 요일 변경
```
문제: 시즌 진행 중 학생이 수업 요일 변경 요청
해결:
  - 원칙: 시즌비는 이미 납부했으므로 요일 변경 가능
  - 단, 주 횟수가 증가하는 경우 추가 금액 청구 필요
```

---

## 10. 구현 우선순위

### Phase 1: 기본 기능
1. ✅ 시즌 설정 CRUD
2. ✅ 시즌 등록 기능
3. ✅ 일할 계산 로직 구현
4. ✅ 일할 계산 미리보기

### Phase 2: 고급 기능
5. ⬜ 중도 해지 및 환불 계산
6. ⬜ 시즌 종료 후 거취 처리 자동화
7. ⬜ 공휴일 관리 기능

### Phase 3: 최적화
8. ⬜ 대량 시즌 등록 일괄 처리
9. ⬜ 시즌비 미납자 자동 알림
10. ⬜ 환불 정책 유연화 (학원별 설정)

---

## 11. 참고 자료

### 학원법 환불 규정
```
학원의 설립·운영 및 과외교습에 관한 법률 시행령 제18조

1. 과오금(반환사유가 발생한 해당 월의 반환 대상 학습비를 말한다)
2. 학습비 징수 기간이 1개월 이내인 경우
   가. 학습 시작 전: 학습비 전액
   나. 총 학습시간 1/3 경과 전: 2/3 해당액
   다. 총 학습시간 1/2 경과 전: 1/2 해당액
   라. 총 학습시간 1/2 경과 후: 반환하지 않음
```

---

## 결론

시즌 전환 로직은 P-ACA 시스템의 핵심 차별화 기능입니다. 정확한 일할 계산과 투명한 환불 정책으로 학원과 학생/학부모 간의 신뢰를 구축할 수 있습니다.

구현 시 특히 주의해야 할 점:
1. **정확성**: 계산 로직의 버그는 직접적인 금전 손실로 이어짐
2. **투명성**: 계산 과정을 명확하게 표시하여 신뢰 확보
3. **유연성**: 학원별 정책 차이를 수용할 수 있는 설정 기능
4. **자동화**: 수동 계산 오류를 방지하는 자동 계산 시스템
