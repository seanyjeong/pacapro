# P-ACA 보안 정책서

## 토스플레이스 연동 보안 가이드

---

## 1. 보안 개요

P-ACA는 학생 개인정보와 결제 정보를 다루는 시스템으로, 다음과 같은 보안 정책을 적용합니다.

### 1.1 보안 원칙

| 원칙 | 설명 |
|------|------|
| **기밀성** | 민감 정보 암호화 저장 및 전송 |
| **무결성** | 데이터 변조 방지, 서명 검증 |
| **가용성** | 서비스 안정성, 장애 복구 |
| **책임 추적성** | 모든 작업 로그 기록 |

---

## 2. 데이터 암호화

### 2.1 저장 시 암호화 (At Rest)

#### 암호화 알고리즘

| 항목 | 사양 |
|------|------|
| **알고리즘** | AES-256-GCM |
| **키 길이** | 256 bits |
| **IV** | 16 bytes (랜덤 생성) |
| **인증 태그** | 16 bytes |

#### 암호화 대상 필드

| 테이블 | 암호화 필드 |
|--------|-----------|
| students | name, phone, parent_phone, address |
| instructors | name, phone, address, resident_number, account_number, account_holder |
| users | name, phone |

#### 암호화 형식

```
ENC:{Base64(IV + AuthTag + EncryptedData)}
```

### 2.2 전송 시 암호화 (In Transit)

| 항목 | 사양 |
|------|------|
| **프로토콜** | HTTPS (TLS 1.2 이상) |
| **인증서** | Let's Encrypt (자동 갱신) |
| **HSTS** | 적용 |

---

## 3. 인증 및 인가

### 3.1 사용자 인증 (JWT)

```
Authorization: Bearer {JWT_TOKEN}
```

| 항목 | 설정 |
|------|------|
| **알고리즘** | HS256 |
| **만료 시간** | 24시간 |
| **갱신 방식** | 재로그인 |

#### JWT Payload

```json
{
  "userId": 1,
  "iat": 1703235600,
  "exp": 1703322000
}
```

### 3.2 플러그인 API 인증

```http
X-Toss-Plugin-Key: {PLUGIN_API_KEY}
X-Academy-Id: {ACADEMY_ID}
```

| 항목 | 설명 |
|------|------|
| **API 키 형식** | 랜덤 문자열 (32자 이상) |
| **학원 ID** | 멀티테넌시 식별자 |
| **검증 방식** | DB 조회 후 일치 확인 |

### 3.3 콜백 서명 검증

```http
X-Toss-Signature: {HMAC_SHA256}
X-Toss-Timestamp: {UNIX_MS}
```

#### 서명 생성

```javascript
const signature = crypto
  .createHmac('sha256', callbackSecret)
  .update(JSON.stringify(requestBody))
  .digest('hex');
```

#### 타임스탬프 검증

- 허용 오차: ±5분
- 리플레이 공격 방지

### 3.4 역할 기반 접근 제어 (RBAC)

| 역할 | 권한 |
|------|------|
| **owner** | 모든 권한 |
| **admin** | 대부분 권한 (삭제 제한) |
| **staff** | 권한 테이블 기반 (페이지별 view/edit) |

---

## 4. 개인정보 보호

### 4.1 수집 정보

| 구분 | 수집 항목 | 수집 목적 |
|------|----------|----------|
| **학생** | 이름, 전화번호, 학교, 학년 | 학원 관리 |
| **보호자** | 전화번호 | 알림톡 발송 |
| **결제** | 결제 금액, 카드사, 승인번호 | 결제 기록 |

### 4.2 개인정보 처리

| 항목 | 정책 |
|------|------|
| **저장** | 암호화 저장 (AES-256-GCM) |
| **조회** | 권한 있는 사용자만 접근 |
| **표시** | 마스킹 처리 (홍*동) |
| **삭제** | Soft Delete (deleted_at) |
| **보관 기간** | 퇴원 후 3년 |

### 4.3 개인정보 처리 방침 URL

```
https://pacapro.vercel.app/privacy
```

---

## 5. API 보안

### 5.1 CORS 정책

```javascript
const corsOptions = {
  origin: '*',  // 플러그인 환경 고려
  methods: 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS',
  credentials: false
};
```

### 5.2 요청 검증

| 항목 | 검증 내용 |
|------|----------|
| **헤더** | API 키 존재 여부 |
| **파라미터** | 필수 값, 타입, 범위 |
| **본문** | JSON 형식, 필드 검증 |
| **학원 ID** | 접근 권한 확인 |

### 5.3 응답 보안

| 항목 | 처리 |
|------|------|
| **민감 정보** | 마스킹 또는 제외 |
| **에러 메시지** | 상세 정보 미노출 |
| **스택 트레이스** | 프로덕션 미노출 |

---

## 6. 결제 보안

### 6.1 결제 데이터 처리

| 항목 | 처리 방식 |
|------|----------|
| **카드 번호** | 마스킹된 값만 저장 (1234-****-****-5678) |
| **CVV/CVC** | 저장하지 않음 |
| **결제 키** | 토스 발급 키 저장 (환불용) |
| **영수증 URL** | 토스 제공 URL 저장 |

### 6.2 중복 결제 방지

```sql
-- 결제 키 기준 중복 체크
SELECT id FROM toss_payment_history WHERE payment_key = ?
```

### 6.3 결제 콜백 보안

| 항목 | 검증 |
|------|------|
| **서명 검증** | HMAC-SHA256 |
| **타임스탬프** | ±5분 허용 |
| **주문번호** | 형식 검증 (PACA-{id}-{ts}) |
| **금액** | 청구 금액과 일치 여부 |

---

## 7. 로깅 및 모니터링

### 7.1 로그 기록

| 로그 유형 | 기록 항목 |
|----------|----------|
| **API 요청** | 메서드, URL, IP, 타임스탬프 |
| **인증** | 로그인 성공/실패, 사용자 ID |
| **결제** | 주문번호, 금액, 상태, 매칭 결과 |
| **에러** | 스택 트레이스, 요청 정보 |

### 7.2 로그 보관

| 구분 | 보관 기간 |
|------|----------|
| **접근 로그** | 90일 |
| **결제 로그** | 5년 |
| **에러 로그** | 30일 |

---

## 8. 장애 대응

### 8.1 자동 매칭 실패 시

1. `toss_payment_queue` 테이블에 저장
2. P-ACA 관리자 화면에서 수동 매칭
3. 결제 금액은 안전하게 보존

### 8.2 서버 장애 시

- 결제는 토스에서 처리 완료
- P-ACA 복구 후 콜백 재처리 가능
- 결제 키로 중복 방지

---

## 9. 보안 체크리스트

### 9.1 개발 보안

- [x] HTTPS 통신
- [x] JWT 인증
- [x] API 키 인증
- [x] 민감정보 암호화
- [x] SQL Injection 방지 (Prepared Statement)
- [x] XSS 방지 (React 자동 이스케이프)
- [x] CSRF 방지 (API 기반, SameSite Cookie 불필요)

### 9.2 운영 보안

- [x] 서버 방화벽
- [x] 정기 백업
- [x] 로그 모니터링
- [x] SSL 인증서 자동 갱신

---

## 10. 연락처

| 구분 | 연락처 |
|------|--------|
| **보안 문의** | security@example.com |
| **기술 지원** | developer@example.com |
| **긴급 연락** | [담당자 연락처] |

---

*문서 버전: 1.0*
*작성일: 2025-12-22*
