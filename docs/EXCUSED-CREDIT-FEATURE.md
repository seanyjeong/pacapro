# 공결 크레딧 자동화 기능

> 구현일: 2025-12-12

---

## 기능 요약

매월 말일 23시에 공결 정산 → 5주차/보충으로 상쇄 → 남은 공결에 대해 크레딧 생성 → 다음달 학원비에서 차감

---

## 핵심 로직

```
5주차 보너스 = max(0, 실제수업일 - 기대수업)
보충 횟수 = is_makeup=1 또는 notes에 '보충' 포함된 출석
상쇄 가능 = 5주차 보너스 + 보충 횟수
남은 공결 = max(0, 공결수 - 상쇄가능)
크레딧 = 남은공결 × (월수강료 ÷ 기대수업) → 천원 절삭
```

**5주차 판단 기준**: 학생 수업요일 기준 실제 수업일 > (주간횟수 × 4)
- 예: 주2회(화목) → 해당 월 화목 합계 > 8이면 5주차 있음

---

## 상쇄 요소

| 요소 | 설명 |
|------|------|
| 5주차 보너스 | 수업 기회 존재 자체가 상쇄 (출석 여부 무관) |
| 보충 수업 | 다른 요일에 실제로 나와서 수업 받으면 상쇄 |

**중요:**
- 일반 결석은 본인 책임 → 크레딧 대상 아님
- **공결만 크레딧 대상**

---

## 수정된 파일

| 파일 | 작업 |
|------|------|
| `utils/seasonCalculator.js` | `countMonthlyClassDays()`, `getFifthWeekClassCount()` 추가 |
| `scheduler/excusedCreditScheduler.js` | **새로 생성** - 매월 말일 23시 실행 |
| `scheduler/paymentScheduler.js` | credit_type IN ('carryover', 'excused') 수정 |
| `paca.js` | excusedCreditScheduler 등록 |

---

## DB 활용

**rest_credits 테이블** 재사용
- `credit_type`: 'carryover' | 'refund' | **'excused'**
- `source_payment_id`: NULL (공결은 특정 납부와 연결 안됨)
- `notes`: '2024년 12월 공결 2회 크레딧 (5주차 보너스: 1, 보충: 0)'

---

## 예시 시나리오

| 학생 | 조건 | 결과 |
|------|------|------|
| A | 주2회, 9일(5주차1), 공결1 | 상쇄됨 → 크레딧 0 |
| B | 주2회, 9일(5주차1), 공결2 | 1회 상쇄 → 크레딧 5만원 |
| C | 주2회, 9일(5주차1), 공결1+결석1 | 결석 무시, 공결 상쇄 → 크레딧 0 |
| D | 주2회, 8일(5주차0), 공결1 | 상쇄 없음 → 크레딧 5만원 |
| E | 주2회, 8일(5주차0), 공결1, 보충1 | 보충으로 상쇄 → 크레딧 0 |
| F | 주2회, 9일(5주차1), 공결3, 보충1 | 2회 상쇄 → 크레딧 5만원 |

---

## 엣지 케이스 처리

| 케이스 | 처리 |
|--------|------|
| 공결 0회 | 크레딧 계산 스킵 |
| 초과 보충 (보충 > 공결) | 초과분 소멸 (다음달로 안 넘김) |
| 월수강료 0원 (체험생) | 크레딧 계산 제외 |
| 월중 등록 | **해당 월 제외** |
| 월중 퇴원 | **해당 월 제외** |
| 휴원 중 (paused) | 대상 제외 (active만) |
| 시즌 학생 | **정규 수업만 대상** |
| 출석체크 안 한 경우 | 공결 0 → 크레딧 0 |

---

## 사유 입력 UI (완료: 2025-12-12)

### 구현 내용

**파일:** `src/components/schedules/attendance-checker.tsx`

**기능:**
- 결석/공결 선택 시 사유 입력 모달 자동 표시
- 공결 설명: "공식적 결석, 원장 승인 필요"
- 결석 설명: "학생 본인 책임, 별도 보상 없음"
- 모바일 최적화 (반응형 디자인)
- 다크모드 지원

**사유 옵션:**
- 공결: 질병, 학교 시험, 기타 (직접 입력)
- 결석: 개인 사정, 무단 결석, 기타 (직접 입력)

### 기존 사유 종류 관리

현재 하드코딩으로 구현됨:
- 공결: 질병, 학교시험
- 결석: 개인사정, 무단결석, 기타

추후 필요시 설정 화면에서 학원별 관리 가능하도록 확장 가능

---

## 스케줄러 실행 정보

```
실행 시점: 매월 말일 23:00 KST
크론 표현식: 매일 23:00 체크, 내일이 1일이면 실행
로그: [ExcusedCreditScheduler] ...
```

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2025-12-12 | 최초 구현 |
| 2025-12-12 | 사유 입력 UI 완료 (모달, 공결 설명, 모바일 최적화) |
