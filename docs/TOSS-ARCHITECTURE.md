# P-ACA 토스플레이스 연동 아키텍처

## 시스템 구성 및 데이터 흐름

---

## 1. 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            인터넷                                        │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────────────┐
│  P-ACA 웹앱     │   │  토스 프론트     │   │     모바일 (PWA)        │
│  (Vercel)       │   │  + 터미널        │   │                         │
│                 │   │                 │   │                         │
│  pacapro.       │   │  P-ACA 플러그인  │   │  pacapro.vercel.app    │
│  vercel.app     │   │                 │   │                         │
└────────┬────────┘   └────────┬────────┘   └────────────┬────────────┘
         │                     │                         │
         │    HTTPS            │    HTTPS                │    HTTPS
         │                     │                         │
         └──────────┬──────────┴─────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     P-ACA 백엔드 (Express.js)                           │
│                                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  /auth      │  │  /students  │  │  /payments  │  │  /toss      │    │
│  │  인증       │  │  학생관리    │  │  결제관리    │  │  토스연동    │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
│                                                                          │
│                        chejump.com/paca (Port 8320)                     │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │       MySQL Database           │
                    │                                │
                    │  students, student_payments,   │
                    │  toss_payment_history,         │
                    │  toss_payment_queue,           │
                    │  toss_settings                 │
                    └────────────────────────────────┘
```

---

## 2. 결제 흐름

### 2.1 정상 결제 흐름 (자동 매칭)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  학원 직원   │     │ 토스 프론트  │     │  P-ACA API  │     │   MySQL     │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │  1. 플러그인 실행   │                   │                   │
       │ ─────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │  2. GET /toss/unpaid                  │
       │                   │ ─────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │  3. 미납자 조회    │
       │                   │                   │ ─────────────────>│
       │                   │                   │<─────────────────│
       │                   │                   │                   │
       │                   │  4. 미납 목록 반환 │                   │
       │                   │<─────────────────│                   │
       │                   │                   │                   │
       │  5. 학생 선택      │                   │                   │
       │ ─────────────────>│                   │                   │
       │                   │                   │                   │
       │  6. 카드 결제      │                   │                   │
       │ ─────────────────>│                   │                   │
       │                   │                   │                   │
       │  7. 영수증 출력    │                   │                   │
       │<─────────────────│                   │                   │
       │                   │                   │                   │
       │                   │  8. POST /toss/payment-callback       │
       │                   │ ─────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │  9. 결제 반영      │
       │                   │                   │ ─────────────────>│
       │                   │                   │<─────────────────│
       │                   │                   │                   │
       │                   │  10. 매칭 완료    │                   │
       │                   │<─────────────────│                   │
       │                   │                   │                   │
```

### 2.2 상세 단계

| 단계 | 주체 | 동작 | API |
|------|------|------|-----|
| 1 | 직원 | 토스 프론트에서 P-ACA 플러그인 실행 | - |
| 2 | 플러그인 | 미납자 목록 요청 | `GET /toss/unpaid` |
| 3 | API | DB에서 미납 학생 조회 | SQL Query |
| 4 | API | 복호화된 목록 반환 | JSON Response |
| 5 | 직원 | 결제할 학생 선택 | - |
| 6 | 직원 | 카드/NFC/현금 결제 | TossFrontSDK |
| 7 | 토스 | 영수증 출력 | - |
| 8 | 토스 | 결제 완료 콜백 | `POST /toss/payment-callback` |
| 9 | API | student_payments 업데이트 | SQL Update |
| 10 | API | 매칭 결과 반환 | JSON Response |

---

## 3. 주문번호 체계

### 3.1 형식

```
PACA-{payment_id}-{timestamp}
```

### 3.2 구성 요소

| 요소 | 설명 | 예시 |
|------|------|------|
| `PACA` | 서비스 식별자 | PACA |
| `payment_id` | student_payments.id | 123 |
| `timestamp` | Unix 타임스탬프 (ms) | 1703235600000 |

### 3.3 파싱 정규식

```javascript
const regex = /^PACA-(\d+)-(\d+)$/;
const match = orderId.match(regex);
// match[1] = payment_id
// match[2] = timestamp
```

---

## 4. 데이터 모델

### 4.1 핵심 테이블 관계

```
┌─────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│    students     │     │   student_payments  │     │ toss_payment_history│
├─────────────────┤     ├─────────────────────┤     ├─────────────────────┤
│ id (PK)         │◄────│ student_id (FK)     │◄────│ payment_id (FK)     │
│ name (암호화)    │     │ academy_id (FK)     │     │ academy_id (FK)     │
│ student_number  │     │ year_month          │     │ order_id            │
│ status          │     │ final_amount        │     │ payment_key         │
│ ...             │     │ paid_amount         │     │ amount              │
└─────────────────┘     │ payment_status      │     │ method              │
                        │ ...                 │     │ approved_at         │
                        └─────────────────────┘     │ receipt_url         │
                                                    │ ...                 │
                                                    └─────────────────────┘

┌─────────────────────┐     ┌─────────────────────┐
│  toss_payment_queue │     │    toss_settings    │
├─────────────────────┤     ├─────────────────────┤
│ id (PK)             │     │ id (PK)             │
│ academy_id          │     │ academy_id (FK, UK) │
│ order_id            │     │ merchant_id         │
│ payment_key         │     │ plugin_api_key      │
│ amount              │     │ callback_secret     │
│ match_status        │     │ is_active           │
│ matched_payment_id  │     │ auto_match_enabled  │
│ error_reason        │     │ ...                 │
│ ...                 │     └─────────────────────┘
└─────────────────────┘
```

### 4.2 상태 전이

#### student_payments.payment_status

```
      생성
        │
        ▼
    ┌───────┐
    │pending│ (미납)
    └───┬───┘
        │ 부분 납부
        ▼
    ┌───────┐
    │partial│ (부분납)
    └───┬───┘
        │ 전액 납부
        ▼
    ┌──────┐
    │ paid │ (완납)
    └──────┘
```

#### toss_payment_queue.match_status

```
      수신
        │
        ▼
    ┌───────┐
    │pending│ (대기중)
    └───┬───┘
        │
   ┌────┴────┐
   │         │
   ▼         ▼
┌───────┐ ┌───────┐
│matched│ │ignored│
└───────┘ └───────┘
```

---

## 5. 에러 처리

### 5.1 자동 매칭 실패 케이스

| 케이스 | 원인 | 처리 |
|--------|------|------|
| `ORDER_ID_FORMAT` | 주문번호 형식 불일치 | 대기열 추가 (pending) |
| `PAYMENT_NOT_FOUND` | payment_id 없음 | 대기열 추가 (error) |
| `ACADEMY_MISMATCH` | 학원 ID 불일치 | 대기열 추가 (error) |

### 5.2 대기열 처리

```
1. 자동 매칭 실패
   │
   ▼
2. toss_payment_queue 저장
   │
   ▼
3. P-ACA 관리자 화면에서 확인
   │
   ├─── 수동 매칭 ───► student_payments 업데이트
   │
   └─── 무시 ────────► match_status = 'ignored'
```

---

## 6. 멀티테넌시

### 6.1 학원별 분리

```
┌─────────────────────────────────────────────────────────────┐
│                     P-ACA 백엔드                             │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Academy 1   │  │ Academy 2   │  │ Academy 3   │         │
│  │ (academy_id │  │ (academy_id │  │ (academy_id │         │
│  │    = 1)     │  │    = 2)     │  │    = 3)     │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                 │
│         ▼                ▼                ▼                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   MySQL Database                     │   │
│  │  (모든 테이블에 academy_id 컬럼으로 분리)             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 API 호출 시 학원 식별

```http
# 헤더로 전달
X-Academy-Id: 1

# 또는 쿼리 파라미터
GET /toss/unpaid?academy_id=1
```

---

## 7. 보안 레이어

```
┌─────────────────────────────────────────────────────────────┐
│                        Client                                │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                     HTTPS (TLS 1.2+)                        │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Nginx (Reverse Proxy)                     │
│                   + SSL Termination                         │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                     Express.js                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │
│  │  CORS   │  │ Helmet  │  │  JWT    │  │ API Key │       │
│  │ Check   │  │ Headers │  │ Verify  │  │ Verify  │       │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘       │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                Route Handlers + Business Logic              │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    MySQL (Encrypted Data)                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 배포 구성

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     Vercel      │     │   Linux Server  │     │     MySQL       │
│                 │     │                 │     │                 │
│  Next.js 15     │     │  Express.js     │     │  Database       │
│  프론트엔드      │────>│  백엔드 API     │────>│  데이터 저장     │
│                 │     │  Port 8320      │     │  Port 3306      │
│  pacapro.       │     │  chejump.com    │     │  localhost      │
│  vercel.app     │     │  /paca          │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │
                               │ Caddy (Reverse Proxy)
                               │ HTTPS 자동 인증서
                               ▼
                        ┌─────────────────┐
                        │   chejump.com   │
                        │   Port 443      │
                        └─────────────────┘
```

---

*문서 버전: 1.0*
*작성일: 2025-12-22*
